<!-- frontend/src/app/cotizacion/nueva-cotizacion/nueva-cotizacion.component.html -->
 <div class="grid grid-cols-12 gap-4 h-full">
  
  <div class="col-span-12 md:col-span-8 flex flex-col gap-4">
    <mat-card class="p-4 border-l-4 border-yellow-500">
      <mat-form-field class="w-full" appearance="outline">
        <mat-label>Agregar producto a cotización...</mat-label>
        <input type="text" matInput [formControl]="productoControl" [matAutocomplete]="autoP">
        <mat-icon matSuffix>search</mat-icon>
        <mat-autocomplete #autoP="matAutocomplete" [displayWith]="displayProd" (optionSelected)="agregarProducto($event.option.value)">
          <mat-option *ngFor="let p of productosFiltrados$ | async" [value]="p">
            <div class="flex justify-between">
              <span>{{p.descripcion}}</span>
              <span class="text-gray-500">{{p.precioUnitario | currency}}</span>
            </div>
          </mat-option>
        </mat-autocomplete>
      </mat-form-field>
    </mat-card>

    <div class="flex-grow overflow-auto bg-white shadow rounded">
      <table mat-table [dataSource]="carrito" class="w-full">
        <ng-container matColumnDef="descripcion">
          <th mat-header-cell *matHeaderCellDef> Descripción </th>
          <td mat-cell *matCellDef="let item"> {{item.descripcion}} </td>
        </ng-container>

        <ng-container matColumnDef="cantidad">
          <th mat-header-cell *matHeaderCellDef> Cant. </th>
          <td mat-cell *matCellDef="let item">
            <input type="number" min="1" [(ngModel)]="item.cantidad" (change)="alCambiarValor(item)" class="w-16 p-1 border rounded text-center">
          </td>
        </ng-container>

        <ng-container matColumnDef="precio">
          <th mat-header-cell *matHeaderCellDef> Precio </th>
          <td mat-cell *matCellDef="let item">
            <input type="number" min="0" [(ngModel)]="item.valorUnitario" (change)="alCambiarValor(item)" class="w-20 p-1 border rounded text-right">
          </td>
        </ng-container>

        <ng-container matColumnDef="importe">
          <th mat-header-cell *matHeaderCellDef> Importe </th>
          <td mat-cell *matCellDef="let item"> {{item.importe | currency}} </td>
        </ng-container>

        <ng-container matColumnDef="acciones">
          <th mat-header-cell *matHeaderCellDef> </th>
          <td mat-cell *matCellDef="let item; let i = index">
            <button mat-icon-button color="warn" (click)="eliminar(i)"><mat-icon>delete</mat-icon></button>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
        <tr class="mat-row" *matNoDataRow>
          <td class="mat-cell text-center p-4" colspan="5">Carrito vacío</td>
        </tr>
      </table>
    </div>
  </div>

  <div class="col-span-12 md:col-span-4 flex flex-col gap-4">
    <mat-card>
      <mat-card-header><mat-card-title>Cliente</mat-card-title></mat-card-header>
      <mat-card-content class="mt-2">
        <mat-form-field class="w-full">
          <mat-label>Buscar Cliente</mat-label>
          <input type="text" matInput [formControl]="clienteControl" [matAutocomplete]="autoC">
          <mat-autocomplete #autoC="matAutocomplete" [displayWith]="displayCli" (optionSelected)="seleccionarCliente($event.option.value)">
            <mat-option *ngFor="let c of clientesFiltrados$ | async" [value]="c">
              {{c.razonSocial}}
            </mat-option>
          </mat-autocomplete>
        </mat-form-field>
        <div *ngIf="clienteSeleccionado" class="bg-yellow-50 p-3 border border-yellow-200 rounded">
          <p class="font-bold">{{clienteSeleccionado.razonSocial}}</p>
          <p class="text-sm">{{clienteSeleccionado.rfc}}</p>
        </div>
      </mat-card-content>
    </mat-card>

    <mat-card class="bg-gray-900 text-white">
      <mat-card-content class="p-6">
        <div class="flex justify-between"><span>Subtotal:</span> <span>{{subtotalGeneral | currency}}</span></div>
        <div class="flex justify-between"><span>IVA:</span> <span>{{ivaGeneral | currency}}</span></div>
        <div class="flex justify-between text-orange-300" *ngIf="retIsrGeneral > 0">
          <span>Ret. ISR:</span> <span>-{{retIsrGeneral | currency}}</span>
        </div>
        <mat-divider class="!bg-gray-600 my-3"></mat-divider>
        <div class="flex justify-between text-2xl font-bold">
          <span>Total:</span> <span>{{totalGeneral | currency}}</span>
        </div>
        <button mat-flat-button color="warn" class="w-full mt-4" (click)="guardar()" [disabled]="!clienteSeleccionado || carrito.length === 0">
          <mat-icon>picture_as_pdf</mat-icon> Generar Cotización
        </button>
      </mat-card-content>
    </mat-card>
  </div>
</div>