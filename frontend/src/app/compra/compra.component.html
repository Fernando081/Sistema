<!-- frontend/src/app/compra/compra.component.html -->
<div class="grid grid-cols-12 gap-4 h-full">
  
  <div class="col-span-12 md:col-span-8 flex flex-col gap-4">
    <mat-card class="p-4">
      <mat-form-field class="w-full" appearance="outline">
        <mat-label>Buscar Producto para ingresar...</mat-label>
        <input type="text" matInput [formControl]="productoControl" [matAutocomplete]="autoProd">
        <mat-icon matSuffix>search</mat-icon>
        <mat-autocomplete #autoProd="matAutocomplete" [displayWith]="displayProducto" 
                          (optionSelected)="agregarProducto($event.option.value)">
          <mat-option *ngFor="let prod of productosFiltrados$ | async" [value]="prod">
            <div class="flex justify-between">
              <span>{{ prod.descripcion }}</span>
              <span class="text-xs text-gray-500">Existencia: {{ prod.existencia }}</span>
            </div>
          </mat-option>
        </mat-autocomplete>
      </mat-form-field>
    </mat-card>

    <div class="flex-grow overflow-auto bg-white shadow rounded">
      <table mat-table [dataSource]="carrito" class="w-full">
        <ng-container matColumnDef="descripcion">
          <th mat-header-cell *matHeaderCellDef> Producto </th>
          <td mat-cell *matCellDef="let item"> 
            <div class="flex flex-col py-2">
              <span class="font-medium">{{ item.descripcion }}</span>
              <span class="text-xs text-gray-400">Cód: {{ item.codigo }}</span>
            </div>
          </td>
        </ng-container>
        <ng-container matColumnDef="cantidad">
          <th mat-header-cell *matHeaderCellDef> Cantidad </th>
          <td mat-cell *matCellDef="let item">
            <input type="number" min="1" class="w-20 p-1 border rounded text-center"
                   [(ngModel)]="item.cantidad" (change)="alCambiarValor(item)">
          </td>
        </ng-container>
        <ng-container matColumnDef="costo">
          <th mat-header-cell *matHeaderCellDef> Costo Unit. </th>
          <td mat-cell *matCellDef="let item">
            <input type="number" min="0" class="w-24 p-1 border rounded text-right"
                   [(ngModel)]="item.costoUnitario" (change)="alCambiarValor(item)">
          </td>
        </ng-container>
        <ng-container matColumnDef="importe">
          <th mat-header-cell *matHeaderCellDef> Importe </th>
          <td mat-cell *matCellDef="let item"> {{ item.importe | currency }} </td>
        </ng-container>
        <ng-container matColumnDef="acciones">
          <th mat-header-cell *matHeaderCellDef> </th>
          <td mat-cell *matCellDef="let item; let i = index">
            <button mat-icon-button color="warn" (click)="eliminarDelCarrito(i)">
              <mat-icon>delete</mat-icon>
            </button>
          </td>
        </ng-container>
        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
      </table>
    </div>
  </div>

  <div class="col-span-12 md:col-span-4 flex flex-col gap-4">
    <mat-card>
      <mat-card-header><mat-card-title>Datos de Compra</mat-card-title></mat-card-header>
      <mat-card-content class="mt-2 flex flex-col gap-3">
        <mat-form-field class="w-full">
          <mat-label>Buscar Proveedor</mat-label>
          <input type="text" matInput [formControl]="proveedorControl" [matAutocomplete]="autoProv">
          <mat-autocomplete #autoProv="matAutocomplete" [displayWith]="displayProveedor"
                            (optionSelected)="seleccionarProveedor($event.option.value)">
            <mat-option *ngFor="let p of proveedoresFiltrados$ | async" [value]="p">
              {{ p.razonSocial }}
            </mat-option>
          </mat-autocomplete>
        </mat-form-field>

        <div *ngIf="proveedorSeleccionado" class="bg-green-50 p-3 rounded text-sm mb-2">
          <p class="font-bold">{{ proveedorSeleccionado.razonSocial }}</p>
          <p>RFC: {{ proveedorSeleccionado.rfc }}</p>
        </div>

        <mat-form-field class="w-full">
          <mat-label>Folio Factura Prov.</mat-label>
          <input matInput [formControl]="folioFacturaControl">
        </mat-form-field>

        <mat-form-field class="w-full">
          <mat-label>Observaciones</mat-label>
          <textarea matInput [formControl]="observacionesControl" rows="2"></textarea>
        </mat-form-field>

        <div class="py-2 flex items-center justify-between border-t border-b">
            <span class="text-sm font-medium text-gray-700">¿Compra a Crédito?</span>
            <mat-slide-toggle [(ngModel)]="esCredito" color="warn">
                {{ esCredito ? 'SÍ (Generar Deuda)' : 'NO (Contado)' }}
            </mat-slide-toggle>
        </div>

      </mat-card-content>
    </mat-card>

    <mat-card class="bg-slate-900 text-white">
      <mat-card-content class="p-6">
        <div class="flex justify-between text-2xl font-bold">
          <span>Total:</span> <span>{{ totalGeneral | currency }}</span>
        </div>
        <button mat-flat-button color="accent" class="w-full mt-6 !py-6" 
                (click)="guardarCompra()" 
                [disabled]="carrito.length === 0 || !proveedorSeleccionado">
          <mat-icon>save_alt</mat-icon> Registrar Entrada
        </button>
      </mat-card-content>
    </mat-card>
  </div>
</div>