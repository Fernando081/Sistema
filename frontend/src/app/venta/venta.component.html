<!-- frontend/src/app/venta/venta.component.html -->
<div class="flex flex-col lg:flex-row gap-4 lg:gap-6 h-full relative">
  <div class="flex-1 flex flex-col gap-4">
    <mat-card class="p-2 md:p-3 !rounded-full !bg-[var(--mat-sys-surface-container-high)]">
      <div class="flex items-center gap-2 px-2">
        <mat-icon class="opacity-60">search</mat-icon>
        <mat-form-field class="w-full" appearance="outline" subscriptSizing="dynamic">
          <mat-label>Escanea o busca el producto</mat-label>
          <input type="text" matInput [formControl]="productoControl" [matAutocomplete]="autoProd">
          <mat-autocomplete #autoProd="matAutocomplete" [displayWith]="displayProducto" (optionSelected)="agregarProducto($event.option.value)">
            <mat-option *ngFor="let prod of productosFiltrados$ | async" [value]="prod" [class.bg-blue-50]="prod.esEquivalente">
              <div class="flex flex-col leading-snug py-1">
                <div class="flex justify-between items-center gap-2">
                  <span class="font-medium truncate">
                    <mat-icon *ngIf="prod.esEquivalente" class="text-blue-500 text-sm !w-4 !h-4 align-middle mr-1">link</mat-icon>
                    {{ prod.descripcion }}
                  </span>
                  <span class="text-xs" [class.text-red-600]="prod.existencia <= 0" [class.text-green-600]="prod.existencia > 0">Stock: {{ prod.existencia }}</span>
                </div>
                <div class="flex justify-between text-xs text-gray-500">
                  <span>{{ prod.codigo || 'S/N' }}<span *ngIf="prod.esEquivalente" class="text-blue-600 font-bold ml-2">(Sugerido)</span></span>
                  <span>{{ prod.precioUnitario | currency }}</span>
                </div>
              </div>
            </mat-option>
          </mat-autocomplete>
        </mat-form-field>
      </div>
    </mat-card>

    <div class="flex-grow overflow-auto responsive-table">
      <table mat-table [dataSource]="carrito" class="w-full">
        <ng-container matColumnDef="descripcion">
          <th mat-header-cell *matHeaderCellDef>Producto</th>
          <td mat-cell *matCellDef="let item" data-label="Producto">
            <div class="flex flex-col py-2">
              <span class="font-medium">{{ item.descripcion }}</span>
              <span class="text-xs text-gray-400">{{ item.claveProdServ }} - {{ item.unidadDescripcion }}</span>
            </div>
          </td>
        </ng-container>

        <ng-container matColumnDef="cantidad">
          <th mat-header-cell *matHeaderCellDef class="w-24">Cant.</th>
          <td mat-cell *matCellDef="let item" data-label="Cantidad">
            <input type="number" min="1" class="line-input w-20" [(ngModel)]="item.cantidad" (change)="alCambiarValor(item)" (keyup)="alCambiarValor(item)">
          </td>
        </ng-container>

        <ng-container matColumnDef="precio">
          <th mat-header-cell *matHeaderCellDef class="w-32">Precio</th>
          <td mat-cell *matCellDef="let item" data-label="Precio">
            <div class="flex items-center">
              <span class="mr-1 opacity-60">$</span>
              <input type="number" min="0" class="line-input w-24 text-right" [(ngModel)]="item.valorUnitario" (change)="alCambiarValor(item)" (keyup)="alCambiarValor(item)">
            </div>
          </td>
        </ng-container>

        <ng-container matColumnDef="importe">
          <th mat-header-cell *matHeaderCellDef>Importe</th>
          <td mat-cell *matCellDef="let item" data-label="Importe">{{ item.importe | currency }}</td>
        </ng-container>

        <ng-container matColumnDef="acciones">
          <th mat-header-cell *matHeaderCellDef></th>
          <td mat-cell *matCellDef="let item; let i = index" data-label="Acciones">
            <button mat-icon-button color="warn" (click)="eliminarDelCarrito(i)"><mat-icon>delete</mat-icon></button>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns; sticky: true"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
        <tr class="mat-row" *matNoDataRow>
          <td class="mat-cell text-center p-4" colspan="5">El carrito está vacío.</td>
        </tr>
      </table>
    </div>
  </div>

  <div class="w-full lg:w-[380px] flex flex-col gap-4 lg:sticky lg:top-24 h-fit">
    <mat-card>
      <mat-card-header><mat-card-title class="text-lg">Datos del Cliente</mat-card-title></mat-card-header>
      <mat-card-content class="mt-2">
        <mat-form-field class="w-full" appearance="fill">
          <mat-label>Buscar Cliente</mat-label>
          <input type="text" matInput [formControl]="clienteControl" [matAutocomplete]="autoCli">
          <mat-autocomplete #autoCli="matAutocomplete" [displayWith]="displayCliente" (optionSelected)="seleccionarCliente($event.option.value)">
            <mat-option *ngFor="let cli of clientesFiltrados$ | async" [value]="cli">
              <div class="flex flex-col leading-snug py-1">
                <span class="font-medium">{{ cli.razonSocial }}</span>
                <span class="text-xs text-gray-500">RFC: {{ cli.rfc }}</span>
              </div>
            </mat-option>
          </mat-autocomplete>
        </mat-form-field>

        <div *ngIf="clienteSeleccionado" class="client-info mb-3">
          <p class="font-bold">{{ clienteSeleccionado.razonSocial }}</p>
          <p>RFC: {{ clienteSeleccionado.rfc }}</p>
          <p>C.P: {{ clienteSeleccionado.codigoPostal }}</p>
        </div>

        <div [formGroup]="configForm" class="flex flex-col gap-2">
          <mat-form-field class="w-full text-sm"><mat-label>Uso CFDI</mat-label><mat-select formControlName="idUsoCFDI"><mat-option *ngFor="let u of usosCfdi$ | async" [value]="u.idUsoCFDI">{{ u.clave }} - {{ u.nombre }}</mat-option></mat-select></mat-form-field>
          <mat-form-field class="w-full text-sm"><mat-label>Método de Pago</mat-label><mat-select formControlName="idMetodoPago"><mat-option *ngFor="let m of metodosPago$ | async" [value]="m.idMetodoDePago">{{ m.clave }} - {{ m.nombre }}</mat-option></mat-select></mat-form-field>
          <mat-form-field class="w-full text-sm"><mat-label>Forma de Pago</mat-label><mat-select formControlName="idFormaPago"><mat-option *ngFor="let f of formasPago$ | async" [value]="f.idFormaPago">{{ f.clave }} - {{ f.nombre }}</mat-option></mat-select></mat-form-field>
        </div>
      </mat-card-content>
    </mat-card>

    <mat-card class="totals-card">
      <mat-card-content class="p-6">
        <h3 class="text-sm uppercase tracking-widest opacity-80 mb-4">Resumen de Venta</h3>
        <div class="flex justify-between mb-2"><span>Subtotal</span><span>{{ subtotalGeneral | currency }}</span></div>
        <div class="flex justify-between mb-2"><span>IVA (16%)</span><span>+ {{ ivaGeneral | currency }}</span></div>
        <div class="flex justify-between mb-4" *ngIf="retIsrGeneral > 0"><span>Ret. ISR (1.25%)</span><span>- {{ retIsrGeneral | currency }}</span></div>
        <mat-divider class="mb-4"></mat-divider>
        <div class="flex justify-between text-3xl font-bold"><span>Total</span><span>{{ totalGeneral | currency }}</span></div>

        <button mat-flat-button color="primary" class="w-full mt-6 pay-button" (click)="guardarVenta()" [disabled]="guardandoVenta || carrito.length === 0 || !clienteSeleccionado">
          <ng-container *ngIf="!guardandoVenta; else savingSaleTpl"><mat-icon>point_of_sale</mat-icon>Cobrar Venta</ng-container>
        </button>
        <ng-template #savingSaleTpl><span class="inline-flex items-center gap-2"><mat-spinner diameter="18"></mat-spinner>Guardando...</span></ng-template>
      </mat-card-content>
    </mat-card>
  </div>
</div>
